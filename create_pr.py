#!/usr/bin/env python3
"""
Catalyst PR Creation Script
Part of the Helix â‡„ Catalyst automation system
"""

import os
import time
import base64
import requests
import jwt
import subprocess
import shlex
from datetime import datetime


class GitHubAppAuth:
    """Handles GitHub App authentication (JWT âœ installation token)."""

    def __init__(self, app_id: str, private_key_path: str, installation_id: str):
        self.app_id = app_id
        self.private_key_path = private_key_path
        self.installation_id = installation_id

    def _generate_jwt(self) -> str:
        with open(self.private_key_path, "r") as fp:
            private_key = fp.read()

        now = int(time.time())
        payload = {"iat": now - 60, "exp": now + 600, "iss": self.app_id}
        return jwt.encode(payload, private_key, algorithm="RS256")

    def installation_token(self) -> str:
        jwt_token = self._generate_jwt()
        headers = {
            "Authorization": f"Bearer {jwt_token}",
            "Accept": "application/vnd.github+json",
        }
        url = (
            f"https://api.github.com/app/installations/"
            f"{self.installation_id}/access_tokens"
        )
        res = requests.post(url, headers=headers)
        res.raise_for_status()
        return res.json()["token"]


def create_automated_pr():
    print("ğŸ¤–  Catalyst PR automation startingâ€¦")

    # â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    app_id = os.getenv("GITHUB_APP_ID", "1488433")
    installation_id = os.getenv("GITHUB_APP_INSTALLATION_ID", "73774755")
    private_key_path = os.getenv("GITHUB_APP_PRIVATE_KEY_PATH")
    repo = os.getenv("GITHUB_REPO", "chybertech/catalyst-test")

    if not private_key_path:
        raise ValueError("GITHUB_APP_PRIVATE_KEY_PATH env-var is required")

    print(f"ğŸ“¦  Repo: {repo}")
    print(f"ğŸ”‘  App ID: {app_id}")
    print(f"ğŸ·ï¸  Installation ID: {installation_id}")

    # â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    token = GitHubAppAuth(app_id, private_key_path, installation_id).installation_token()
    headers = {
        "Authorization": f"Bearer {token}",
        "Accept": "application/vnd.github+json",
    }
    print("âœ…  GitHub App authentication OK")

    # â”€â”€ Branch creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ts_slug = datetime.now().strftime("%Y%m%d-%H%M%S")
    branch_name = f"catalyst/autopr-demo-{ts_slug}"
    print(f"ğŸŒ¿  Creating branch {branch_name}")

    # fetch main SHA
    main_ref_url = f"https://api.github.com/repos/{repo}/git/ref/heads/main"
    main_sha = requests.get(main_ref_url, headers=headers).json()["object"]["sha"]
    print(f"ğŸ“  main SHA = {main_sha[:8]}")

    # create new branch
    ref_url = f"https://api.github.com/repos/{repo}/git/refs"
    requests.post(
        ref_url,
        headers=headers,
        json={"ref": f"refs/heads/{branch_name}", "sha": main_sha},
    ).raise_for_status()

    # â”€â”€ File payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    timestamp_iso = datetime.now().isoformat()
    md_body = f"""# Catalyst Automation Test

**Generated by**: Catalyst (Claude-powered agent)  
**Timestamp**: {timestamp_iso}  
**Branch**: {branch_name}  
**Repository**: {repo}

This PR validates the end-to-end Helix â‡„ Catalyst workflow.

## âœ… Capabilities tested
- GitHub App auth (JWT âœ installation token)
- Branch creation
- File commit
- Pull-request creation

---

ğŸ¤– *Automated by Catalyst*
"""
    encoded = base64.b64encode(md_body.encode()).decode()

    file_url = f"https://api.github.com/repos/{repo}/contents/AUTOMATION_TEST.md"
    requests.put(
        file_url,
        headers=headers,
        json={
            "message": f"ğŸ¤– Catalyst automation test: {timestamp_iso}",
            "content": encoded,
            "branch": branch_name,
        },
    ).raise_for_status()

    # â”€â”€ PR creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    pr_title = f"ğŸ¤– Catalyst Automation Validation â€“ {ts_slug}"
    pr_resp = requests.post(
        f"https://api.github.com/repos/{repo}/pulls",
        headers=headers,
        json={
            "title": pr_title,
            "head": branch_name,
            "base": "main",
            "body": md_body,
        },
    )
    pr_resp.raise_for_status()
    pr = pr_resp.json()

    # â”€â”€ Auto-merge request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try:
        subprocess.run(
            shlex.split(
                f"gh pr merge {pr['number']} --auto --squash --repo {repo}"
            ),
            check=True,
        )
        print("ğŸ”„  Auto-merge enabled (will trigger once CI passes).")
    except subprocess.CalledProcessError as err:
        print("âš ï¸  Could not enable auto-merge â€”", err)

    # â”€â”€ Output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\nğŸ‰  AUTOMATION SUCCESS")
    print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
    print(f"PR   : {pr['html_url']}")
    print(f"Branch: {branch_name}")
    print(f"Number: #{pr['number']}")
    print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")
    return pr


if __name__ == "__main__":
    try:
        create_automated_pr()
    except Exception as exc:
        print(f"\nâŒ  Automation failed: {exc}")
        raise